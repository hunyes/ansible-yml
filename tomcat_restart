- hosts: all
  become: true

  vars:
    tomcat_folder: tomcat/bin
    tomcat_path: "/testspace/{{ tomcat_folder }}"
    grep_string: "[/]testspace/{{ tomcat_folder }}"

  tasks:
    - name: ==> shutdown tomcat ,path = "{{ tomcat_path }}/bin/"
      command: sh {{ tomcat_path }}/bin/shutdown.sh
      #command: bash -c "{{ tomcat_path }}/tomcat.sh stop"

    - name: ==> sleep 3s
      command: sleep 3s

    - name: check if tomcat is running
      shell: ps aux | grep '{{ grep_string }}' | awk '{print $2}'
      ignore_errors: yes
      changed_when: false
      register: service_tomcat_status

    #- debug: msg="check if tomcat is running {{ service_tomcat_status }}"
    - debug: msg="service_tomcat_status = {{ service_tomcat_status.stdout != ''}}"

    - name: kill process is tomcat is still running
      shell: kill $(ps aux | grep '{{ grep_string }}' | awk '{print $2}')
      when: service_tomcat_status.stdout != ''

    - command: sleep 1s
      when: service_tomcat_status.stdout != ''

    - name: ==> startup qle tomcat , path = {{ tomcat_path }}/bin/startup.sh
      shell: setsid /bin/sh -i -c "{{ tomcat_path }}/bin/startup.sh"
      #shell: setsid /bin/sh -i -c "{{ tomcat_path }}/tomcat.sh start"
